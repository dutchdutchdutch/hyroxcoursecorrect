<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Venue Statistics - HYROX Course Correct</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>

<body>
    <div class="container">
        <header>
            <h1>üèÉ HYROX Course Correct</h1>
            <p class="subtitle">Detailed Venue Statistics</p>
        </header>

        <nav class="nav-tabs">
            <a href="/" class="nav-tab">Time Converter</a>
            <a href="/analysis" class="nav-tab">Venue Analysis</a>
            <a href="/statistics" class="nav-tab active">Statistics</a>
        </nav>

        <main>
            <!-- Distribution Chart (moved above table) -->
            <div class="card distribution-card">
                <h2>Finish Time Distribution</h2>
                <p class="description">
                    Distribution of finish times across all athletes. Use filters to explore patterns by gender and
                    venue.
                </p>

                <div class="distribution-filters">
                    <div class="filter-group">
                        <label>Gender:</label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="filter-men" checked> Men
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="filter-women" checked> Women
                        </label>
                    </div>

                    <div class="filter-group">
                        <label for="venue-select">Venues:</label>
                        <select id="venue-select" multiple>
                            <option value="" selected>All Venues</option>
                            {% for venue in venues %}
                            <option value="{{ venue }}">{{ venue }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="chart-container" style="position: relative; height: 380px; margin-top: 1rem;">
                    <canvas id="distributionChart"></canvas>
                </div>

                <p id="distribution-summary"
                    style="margin-top: 1rem; text-align: center; font-size: 0.9rem; color: #666;">
                    Loading...
                </p>
            </div>

            <!-- Venue Performance Table -->
            <div class="card">
                <h2>Venue Performance Statistics</h2>
                <p class="description">
                    Detailed metrics for each venue based on <strong>top 80% of finishers</strong> ({{ total_athletes }}
                    total athletes across {{ num_venues }} venues).
                    All times shown in h:mm:ss format.
                </p>

                {% if stats_data %}
                <div class="table-container">
                    <table class="stats-table" id="venue-stats-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Venue</th>
                                <th>Sample Size</th>
                                <th>Fastest Time</th>
                                <th>Slowest Time</th>
                                <th>Average</th>
                                <th class="highlight-col">Men's Benchmark</th>
                                <th class="highlight-col">Women's Benchmark</th>
                                <th>Std Dev</th>
                                <th>Course Correction</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in stats_data %}
                            <tr data-venue="{{ stat.name }}"
                                class="{{ 'baseline-row' if 'Baseline' in stat.correction_label else '' }}">
                                <td class="rank-cell">{{ loop.index }}</td>
                                <td class="venue-cell"><strong>{{ stat.name }}</strong></td>
                                <td>{{ stat.count }}</td>
                                <td>{{ stat.fastest }}</td>
                                <td>{{ stat.slowest }}</td>
                                <td>{{ stat.average }}</td>
                                <td class="benchmark-cell"><strong>{{ stat.men_benchmark }}</strong></td>
                                <td class="benchmark-cell"><strong>{{ stat.women_benchmark }}</strong></td>
                                <td>{{ stat.std_dev }}</td>
                                <td class="difficulty-cell">
                                    {% if 'Baseline' in stat.correction_display %}
                                    <span class="badge reference">{{ stat.correction_display }}</span>
                                    {% else %}
                                    <span class="badge">{{ stat.correction_display }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="no-data">No statistics data available. Please run the data processing pipeline first.</p>
                {% endif %}
            </div>

            <div class="info-card">
                <h3>Understanding the Statistics</h3>
                <ul>
                    <li><strong>Sample Size:</strong> Number of athletes included (top 80% of finishers)</li>
                    <li><strong>Fastest/Slowest Time:</strong> Range of finish times at this venue</li>
                    <li><strong>Average:</strong> Mean finish time across all athletes</li>
                    <li><strong>Men's Benchmark (highlighted):</strong> Median finish time for men only (50th
                        percentile)</li>
                    <li><strong>Women's Benchmark (highlighted):</strong> Median finish time for women only (50th
                        percentile)</li>
                    <li><strong>Std Dev:</strong> Standard deviation showing time consistency</li>
                    <li><strong>Course Correction:</strong> Percentage showing how this venue compares to the baseline
                        (median-difficulty) venue. Positive values mean you add time (faster course), negative values
                        mean you subtract time (slower course)</li>
                </ul>

                <h4 style="margin-top: 1.5rem; color: #004E89;">Gender Performance Insights: Run Distance Effects</h4>
                <p style="margin-top: 0.5rem;">
                    Our analysis reveals that <strong>run distance significantly affects men and women
                        differently</strong>.
                    The gender-specific benchmarks (highlighted columns) show distinct patterns across venues:
                </p>

                <div style="margin-top: 1rem; padding-left: 1rem; border-left: 3px solid #FF6B35;">
                    <p style="margin-bottom: 0.75rem;">
                        <strong style="color: #FF6B35;">Long-Distance Venues</strong> (Atlanta, Chicago, Anaheim):<br>
                        Men's times are disproportionately slower relative to baseline. These venues feature longer run
                        loops,
                        suggesting that extended endurance demands impact male athletes more significantly. This may
                        relate to
                        pacing strategies or the strength-to-endurance ratio required for sustained running.
                    </p>

                    <p style="margin-bottom: 0.75rem;">
                        <strong style="color: #06D6A0;">Short-Distance Venues</strong> (Bordeaux, Dublin):<br>
                        Women's times show greater relative slowdown compared to men. Shorter, more intense run segments
                        may favor different physiological profiles, with the higher power-to-weight demands potentially
                        affecting female athletes differently.
                    </p>

                    <p style="margin-bottom: 0.75rem;">
                        <strong style="color: #004E89;">Moderate-Distance Venues</strong> (Frankfurt, Valencia):<br>
                        These venues show minimal gender difference (1-2%), providing the most balanced challenge across
                        genders. The moderate run distances appear to create a more equitable test of overall fitness.
                    </p>
                </div>

                <p style="margin-top: 1rem;">
                    <strong>Practical Implications:</strong> Male athletes should emphasize endurance training for
                    long-run venues,
                    while female athletes may benefit from power/speed work for short-run venues. When selecting target
                    venues,
                    consider run distance as a key factor in performance optimization.
                </p>

                <p style="margin-top: 1rem;">
                    <strong>Note:</strong> Data includes only the top 80% of finishers to exclude slow outliers and
                    ensure
                    accurate venue comparisons. Lower standard deviation indicates more consistent finish times.
                </p>
            </div>
        </main>

        <footer>
            <p>Built with ‚ù§Ô∏è for the HYROX community | Season 8 (2025/2026)</p>
        </footer>
    </div>

    <style>
        .table-container {
            overflow-x: auto;
            margin: 1.5rem 0;
        }

        .stats-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .stats-table thead {
            background-color: #004E89;
            color: white;
        }

        .stats-table th {
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
        }

        .stats-table th.highlight-col {
            background-color: #FFB800;
            color: #004E89;
        }

        .stats-table tbody tr {
            border-bottom: 1px solid #E1E8ED;
        }

        .stats-table tbody tr:hover {
            background-color: #F7F9FC;
        }

        .stats-table tbody tr.baseline-row {
            background-color: #DCFCE7;
            /* Light Green */
        }

        .stats-table tbody tr.baseline-row:hover {
            background-color: #D1FAE5;
            /* Slightly darker green on hover */
        }

        .stats-table td {
            padding: 0.75rem;
        }

        .rank-cell {
            text-align: center;
            font-weight: 600;
            color: #004E89;
        }

        .venue-cell {
            min-width: 180px;
        }

        .benchmark-cell {
            background-color: #FFF9E6;
            color: #004E89;
        }

        .difficulty-cell {
            text-align: center;
        }

        .no-data {
            text-align: center;
            padding: 2rem;
            color: #666;
            font-style: italic;
        }

        /* Distribution Chart Card */
        .distribution-card {
            padding-bottom: 4rem;
            margin-bottom: 2rem;
        }

        .distribution-card .chart-container {
            overflow: visible;
        }

        /* Distribution Chart Filters */
        .distribution-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            align-items: center;
            margin-top: 1rem;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .filter-group>label:first-child {
            font-weight: 600;
            color: #495057;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            cursor: pointer;
        }

        .checkbox-label input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary-color);
        }

        #venue-select {
            min-width: 200px;
            max-width: 300px;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.9rem;
            height: 80px;
        }

        @media (max-width: 768px) {
            .stats-table {
                font-size: 0.8rem;
            }

            .stats-table th,
            .stats-table td {
                padding: 0.5rem;
            }

            .distribution-filters {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let distributionChart = null;

        async function fetchAndRenderChart() {
            const includeMen = document.getElementById('filter-men').checked;
            const includeWomen = document.getElementById('filter-women').checked;
            const venueSelect = document.getElementById('venue-select');
            const selectedVenues = Array.from(venueSelect.selectedOptions)
                .map(opt => opt.value)
                .filter(v => v !== '');

            // Build query params
            const params = new URLSearchParams();
            if (includeMen) params.append('gender', 'M');
            if (includeWomen) params.append('gender', 'W');
            selectedVenues.forEach(v => params.append('venue', v));

            try {
                const response = await fetch('/api/distribution-data?' + params.toString());
                const data = await response.json();
                renderChart(data);
            } catch (error) {
                console.error('Error fetching distribution data:', error);
            }
        }

        function renderChart(data) {
            const ctx = document.getElementById('distributionChart').getContext('2d');

            // Destroy old chart if exists
            if (distributionChart) {
                distributionChart.destroy();
            }

            // Update summary
            const summaryEl = document.getElementById('distribution-summary');
            summaryEl.textContent = `Showing ${data.total.toLocaleString()} athletes`;

            // Create new chart
            distributionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.bins,
                    datasets: [{
                        label: 'Athletes',
                        data: data.counts,
                        backgroundColor: 'rgba(255, 107, 53, 0.7)',
                        borderColor: 'rgba(255, 107, 53, 1)',
                        borderWidth: 1,
                        barPercentage: 1.0,
                        categoryPercentage: 1.0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            left: 10,
                            right: 10,
                            bottom: 10
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function (context) {
                                    return 'Finish time: ' + context[0].label;
                                },
                                label: function (context) {
                                    return context.raw.toLocaleString() + ' athletes';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Finish Time (h:mm)',
                                font: { size: 11 }
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: { size: 10 },
                                autoSkip: true,
                                maxTicksLimit: 15
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Number of Athletes',
                                font: { size: 11 }
                            },
                            beginAtZero: true,
                            ticks: {
                                font: { size: 10 }
                            }
                        }
                    }
                }
            });
        }

        function filterTable() {
            const venueSelect = document.getElementById('venue-select');
            const selectedVenues = Array.from(venueSelect.selectedOptions)
                .map(opt => opt.value)
                .filter(v => v !== '');

            const table = document.getElementById('venue-stats-table');
            if (!table) return;

            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const venueAttr = row.getAttribute('data-venue');
                if (selectedVenues.length === 0) {
                    // "All Venues" selected - show all
                    row.style.display = '';
                } else {
                    // Show only matching venues
                    row.style.display = selectedVenues.includes(venueAttr) ? '' : 'none';
                }
            });
        }

        function updateAll() {
            fetchAndRenderChart();
            filterTable();
        }

        // Event listeners
        document.getElementById('filter-men').addEventListener('change', fetchAndRenderChart);
        document.getElementById('filter-women').addEventListener('change', fetchAndRenderChart);
        document.getElementById('venue-select').addEventListener('change', updateAll);

        // Initial load
        fetchAndRenderChart();
    </script>
</body>

</html>