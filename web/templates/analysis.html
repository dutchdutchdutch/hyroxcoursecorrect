<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Venue Analysis - HYROX Course Correct</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
</head>

<body>
    <div class="container">
        <header>
            <h1>üèÉ HYROX Course Correct</h1>
            <p class="subtitle">Venue Performance Analysis</p>
        </header>

        <nav class="nav-tabs">
            <a href="/" class="nav-tab">Time Converter</a>
            <a href="/analysis" class="nav-tab active">Venue Analysis</a>
            <a href="/statistics" class="nav-tab">Statistics</a>
        </nav>

        <main>
            <div class="card">
                <h2>Venue Time Distribution</h2>
                <p class="description">
                    Box plot showing finish time distributions across venues. This is the primary visual indicator of
                    course difficulty.
                </p>
                <div id="distributionChart"></div>
            </div>

            <div class="card">
                <h2>Statistical Summary</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Fastest Venue</div>
                        <div class="stat-value">{{ fastest_venue }}</div>
                        <div class="stat-detail">Reference (1.000)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Slowest Venue</div>
                        <div class="stat-value">{{ slowest_venue }}</div>
                        <div class="stat-detail">{{ slowest_diff }}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Athletes</div>
                        <div class="stat-value">{{ total_athletes }}</div>
                        <div class="stat-detail">Across all venues</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Venues Analyzed</div>
                        <div class="stat-value">{{ num_venues }}</div>
                        <div class="stat-detail">Season 8 (2025/26)</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Venue Rankings</h2>
                <p class="description">
                    Venues sorted by median finish time (fastest to slowest)
                </p>
                <div class="venue-ranking">
                    {% for venue in venue_stats %}
                    <div class="ranking-item">
                        <div class="rank-number">{{ loop.index }}</div>
                        <div class="rank-info">
                            <div class="rank-venue">{{ venue.name }}</div>
                            <div class="rank-stats">
                                Venue Benchmark: {{ venue.median }} | Average: {{ venue.mean }} | n={{ venue.count }}
                            </div>
                        </div>
                        <div class="rank-badge">
                            {% if venue.handicap == 1.0 %}
                            <span class="badge reference">Reference</span>
                            {% else %}
                            <span class="badge">{{ venue.difficulty }}</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="info-card">
                <h3>Understanding the Chart</h3>
                <ul>
                    <li><strong>Box:</strong> Middle 50% of finish times (25th to 75th percentile)</li>
                    <li><strong>Line in Box:</strong> Venue Benchmark (median finish time)</li>
                    <li><strong>√ó Symbol:</strong> Average (mean) finish time</li>
                    <li><strong>Whiskers:</strong> Range of typical finish times (excluding outliers)</li>
                    <li><strong>Dots:</strong> Individual outlier performances</li>
                </ul>
                <p style="margin-top: 1rem;">
                    Venues with higher Venue Benchmark times are more difficult. The width of the box shows consistency‚Äî
                    narrower boxes indicate more consistent finish times.
                </p>
            </div>
        </main>

        <footer>
            <p>Built with ‚ù§Ô∏è for the HYROX community | Season 8 (2025/2026)</p>
        </footer>
    </div>

    <script>
        // Venue data from Flask
        const venueData = {{ venue_data | tojson }};

        // Helper function to convert seconds to h:mm format
        function secondsToHMM(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${hours}:${minutes.toString().padStart(2, '0')}`;
        }

        // Create box plot traces
        const traces = venueData.map(venue => ({
            y: venue.times,
            name: venue.name,
            type: 'box',
            boxmean: true,  // Show mean as dashed line
            marker: {
                color: venue.color
            }
        }));

        // Calculate median for each venue and create annotations
        const annotations = venueData.map((venue, index) => {
            const sortedTimes = [...venue.times].sort((a, b) => a - b);
            const median = sortedTimes[Math.floor(sortedTimes.length / 2)];

            return {
                x: index,
                y: median,
                yshift: -5,  // Position 5 pixels below the median line
                text: `<b>${secondsToHMM(median)}</b>`,
                showarrow: false,
                font: {
                    size: 11,
                    color: '#004E89'
                },
                xref: 'x',
                yref: 'y'
            };
        });

        const layout = {
            title: {
                text: 'Finish Time Distribution by Venue<br><sub>Box = middle 50% | Line = Venue Benchmark (median) | Dotted line = Average</sub>',
                font: { size: 18, color: '#004E89' }
            },
            yaxis: {
                title: 'Finish Time (H:MM)',
                gridcolor: '#E1E8ED',
                tickmode: 'array',  // Use array mode to display custom tick labels
                tickvals: [],
                ticktext: []
            },
            xaxis: {
                title: 'Venue',
                tickangle: -45
            },
            plot_bgcolor: '#F7F9FC',
            paper_bgcolor: 'white',
            margin: { t: 80, b: 120, l: 80, r: 40 },
            height: 550,
            showlegend: false,
            hovermode: false,  // Disable hover tooltips
            annotations: annotations
        };

        // Generate tick values and labels for y-axis (h:mm format)
        const minTime = Math.min(...venueData.flatMap(v => v.times));
        const maxTime = Math.max(...venueData.flatMap(v => v.times));
        const startTick = Math.floor(minTime / 600) * 600;
        const endTick = Math.ceil(maxTime / 600) * 600;

        for (let tick = startTick; tick <= endTick; tick += 600) {
            layout.yaxis.tickvals.push(tick);
            layout.yaxis.ticktext.push(secondsToHMM(tick));
        }

        const config = {
            responsive: true,
            displayModeBar: true,
            displaylogo: false,
            modeBarButtonsToRemove: ['lasso2d', 'select2d']
        };

        Plotly.newPlot('distributionChart', traces, layout, config);
    </script>
</body>

</html>